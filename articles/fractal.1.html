<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Jsonnet - Fractal Application (1/3)</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <meta name="keywords" content="Jsonnet, JSON, YAML, language, configuration, configuration language, functional, declarative, lazy, structured, elegant, semantics, clean, mixins, inheritance, template, expansion, expand" />
    <meta name="description" content="A powerful DSL for elegant description of JSON data." />
    <meta name="viewport" content="width=576">

    <link rel="icon" type="image/png" href="/favicon.png" />

    <!-- MathJax (for semantics) -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        displayAlign: "left",
        imageFont: null,
    });
    </script>
    <script type="text/javascript" src="/third_party/MathJax-2.7.2/MathJax.js"></script>
    <script type="text/javascript" src="/third_party/anchor.min.js"></script>


    <!-- Google Analytics -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-53570216-1', 'auto');
      ga('send', 'pageview');
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,400,600,700" rel="stylesheet" type="text/css">

    <!-- CodeMirror -->
    <link rel="stylesheet" href="/third_party/CodeMirror/lib/codemirror.css">
    <script src="/third_party/js-yaml/dist/js-yaml.min.js"></script>
    <script src="/third_party/CodeMirror/lib/codemirror.js"></script>
    <script src="/third_party/CodeMirror/mode/yaml/yaml.js"></script>
    <script src="/third_party/CodeMirror/addon/edit/matchbrackets.js"></script>
    <script src="/js/codemirror-mode-jsonnet.js"></script>

    <!-- Executing Jsonnet -->
    <script src="/js/wasm_exec.js"></script>
    <script>
        if (!WebAssembly.instantiateStreaming) {
            // This function was observed to be missing on Safari 14.
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
                const source = await (await resp).arrayBuffer();
                return await WebAssembly.instantiate(source, importObject);
            };
        }
        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("/js/libjsonnet.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
        });
    </script>
    <script src="/js/demo.js"></script>

    <!-- Navigation menus -->
    <script src="/js/menu.js"></script>

    <!-- jsonnet.org stylesheet -->
    <link rel="stylesheet" type="text/css" href="/css/doc.css" />
    <link rel="stylesheet" media="print" href="/css/desktop.css">
    <!-- The extra 16px is to account for the scrollbar, which is not always included. -->
    <link rel="stylesheet" media="screen and (min-width: 1296px)" href="/css/desktop.css">
    <link rel="stylesheet" media="screen and (max-width: 1295px) and (min-width: 720px)" href="/css/cellphone.css">
    <link rel="stylesheet" media="screen and (max-width: 719px)" href="/css/cellphone-small.css">
</head>

<body>

<div id=header>
  <div class=header2>
    <a id=header-logo class=header-element href="/"><img src="/img/isologo.svg"></a>
    <a id=header-title class=header-element href="/">Jsonnet</a>

    <div class="header-element menu">
      <div onclick='menu_open_popup(find_enclosing_menu(this))' onmouseover='menu_open_popup(find_enclosing_menu(this))' onmouseout='menu_leave()'>
        Learning
      </div>
      <div class=pop-up onmouseover='menu_open_popup(find_enclosing_menu(this))' onmouseout='menu_leave()'>
        <a href="/learning/tutorial.html">Tutorial</a>
        <a href="/learning/getting_started.html">Getting Started</a>
        <a href="/learning/tools.html">Tools</a>
        <a href="/learning/community.html">Community</a>
      </div>
    </div>

    <div class="header-element menu">
      <div onclick='menu_open_popup(find_enclosing_menu(this))' onmouseover='menu_open_popup(find_enclosing_menu(this))' onmouseout='menu_leave()'>
        Reference
      </div>
      <div class=pop-up onmouseover='menu_open_popup(find_enclosing_menu(this))' onmouseout='menu_leave()'>
        <a href="/ref/language.html">Language Reference</a>
        <a href="/ref/stdlib.html">Standard Library</a>
        <a href="/ref/spec.html">Specification</a>
        <a href="/ref/bindings.html">Bindings</a>
      </div>
    </div>

    <div class="header-element menu">
      <div onclick='find_enclosing_menu(menu_open_popup(this))' onmouseover='menu_open_popup(find_enclosing_menu(this))' onmouseout='menu_leave()'>
        Articles
      </div>
      <div class=pop-up onmouseover='menu_open_popup(find_enclosing_menu(this))' onmouseout='menu_leave()'>
        <a href="/articles/fractal.1.html">Terraform & Packer</a>
        <a href="/articles/kubernetes.html">Kubernetes</a>
        <a href="/articles/output-formats.html">Output Formats</a>
        <a href="/articles/design.html">Design Rationale</a>
        <a href="/articles/comparisons.html">Comparisons</a>
      </div>
    </div>
    <a id=groupsmark class=header-element href="https://groups.google.com/g/jsonnet"></a>
    <a id=githubmark class=header-element href="https://github.com/google/jsonnet"></a>
    <a id=gomark class=header-element href="https://github.com/google/go-jsonnet"></a>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <h1 id=top>
        <p class=jump_to_page_top>
          Pages 1,
          <a href="fractal.2.html">2</a>,
          <a href="fractal.3.html">3</a>
        </p>
        Fractal Application
      </h1>
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <h2 id=intro>Introduction</h2>
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <p>
        This case study illustrates that <a href="/index.html">Jsonnet</a> can be used to
        centralize, unify, and manage configuration for all parts of a cloud hosted multi-tier web
        application (a Mandelbrot viewer).  Jsonnet centralizes configuration files for the various
        application software, database schemas and initial data sets, system configuration files,
        package manifests, software build configurations, image configurations (<a
        href="https://www.packer.io/">Packer</a>) and cloud resources / connectivity (<a
        href="https://www.terraform.io/">Terraform</a>).  Although the running example is deployed on
        <a href="https://cloud.google.com">Google Cloud Platform</a> and uses specific application
        software, Jsonnet can be used to generate configuration for any application and (via Packer
        &amp; Terraform) a wide range of cloud providers.
      </p>

      <p>
        Prerequisites: It is assumed that the reader has read the Jsonnet <a
        href="/docs/tutorial.html">tutorial</a>, and has a basic knowledge of Packer and Terraform.
      </p>
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <h2 id=app>Example Web Application</h2>
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <a href="/img/fractal_screenshot.png"><img src="/img/fractal_screenshot.png" class="wide"></a>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <p>
        The example application allows the user to zoom and pan a Mandelbrot fractal (dynamically
        rendered server side, in C++).  The user is able to save the location of features they find,
        deep in the fractal, and a time-ordered list of these with thumbnails is displayed in the
        left hand pane.  The application is provisionally hosted <a
        href="http://www.fractaldemo.com/">here</a>, but you can easily deploy your own as all
        required files are available in the Jsonnet repository.
      </p>
      <p>
        Although admittedly a little contrived, this example is intended to represent the structure
        of a typical non-trivial real-world web application.  It is an example of micro-service
        architecture (illustrated below).  The services are:  An Application Server, a backend
        database (Cassandra) and a backend service for generating the fractal PNG tiles (C++).  Each
        service is scalable and fault-tolerant.
      </p>
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="inverse hgroup">
  <div class="hgroup-inline">
    <div class="panel wide">
      <img src="/img/fractal_architecture.png">
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <p>
        The Application Server hosts static content (CSS) and Jinja'd HTML.  The <a href="https://github.com/google/jsonnet/blob/master/case_studies/fractal/appserv/templates/page.html">HTML</a> contains JavaScript that
        issues AJAX requests to 1) the Tile Generating Service and 2) the Application Server (to
        fetch / amend the discoveries list).  The Application Server therefore does not communicate
        directly with the fractal Tile Generating Service, but it needs to know the host:port
        endpoint in order to embed it in the HTML so that the user's browser can do so.  The user
        does not communicate directly with the Cassandra database.
      </p>
      <p>
        Both the Application server and the tile generation service use Nginx, uWSGI and flask to
        host their content.  For the application Server, this means transforming HTTP requests into
        database accesses and/or serving content (code <a href="https://github.com/google/jsonnet/blob/master/case_studies/fractal/appserv/main.py">here</a>).  For the tile generation service, this means invoking
        a compiled C++ <a href="https://github.com/google/jsonnet/blob/master/case_studies/fractal/tilegen/mandelbrot.cpp">executable</a>
        from the Flask <a href="https://github.com/google/jsonnet/blob/master/case_studies/fractal/tilegen/mandelbrot_service.py">handler</a> in order to construct a PNG for a
        given tile / thumbnail of the fractal.  Both services consist of a group of <a
        href="https://cloud.google.com/compute/docs/instances">instances</a> behind a <a
        href="https://cloud.google.com/compute/docs/load-balancing/network/">layer 3 cloud load
        balancer</a> with a static IP and a simple <a
        href="https://cloud.google.com/compute/docs/load-balancing/health-checks">health check</a>.
        The Cassandra database is simply a set of instances, as the Cassandra client library (used
        by the Application Server) does client-side load balancing and transparent failover, thus
        does not need a cloud load balancer.
      </p>
      <p>
        The application is deployed by first using Packer to build an image for each of the 3 kinds
        of cloud instances (Application Server, Tile Generating Service, Cassandra).  Then, all the
        cloud resources (instances, load balancers, etc.) are deployed using Terraform.  The Packer
        build compiles, installs and configures all of the required software on each image.  The
        Terraform configuration provides last minute configuration (host:port endpoints, passwords,
        etc.) to the instances via <a
        href="https://cloud.google.com/compute/docs/metadata">metadata</a>.
      </p>
      <p>
        The choice about what configuration to provide at image build time (embedded in Packer
        configurations) vs deployment time (embedded in Terraform configuration) is up to the user.
        The advantage of doing more at image build time is that instances can then be deployed more
        quickly (useful in an auto-scaling situation).  But allowing some configuration at
        deployment time makes the images more flexible.  Some configuration (e.g. host:port
        endpoints) is only known at deployment time so must be specified in the Terraform
        configuration.  In our case, we try to do all time consuming steps (downloading, generating,
        compiling) in Packer, while leaving finer details until deployment.
      </p>
    </div>
    <div style="clear: both"></div>
  </div>
</div>

<div class="hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <p class=jump_to_page>
        Pages 1,
        <a href="fractal.2.html">2</a>,
        <a href="fractal.3.html">3</a>
      </p>
    </div>
    <div style="clear: both"></div>
  </div>
</div>



<div class="inverse hgroup">
  <div class="hgroup-inline">
    <div class="panel">
      <p class=footer>
        Except as noted, this content is licensed under Creative Commons Attribution 2.5.
      </p>
    </div>
  </div>
</div>

<script>
  anchors.options = {
    placement: 'right',
    visible: 'always',
    icon: '#'
  };
  anchors.add('h2,h3');
</script>
</body>

</html>

